<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>HREI CRM - Members Area</title>
  <link rel="stylesheet" href="../styles.css">
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = { theme: { extend: { colors: { brand: { DEFAULT:'#0B5C63', dark:'#073C40', accent:'#F59E0B' }}}}};</script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body class="bg-slate-100">

  <!-- Authentication Guard (FIXED: removed type="module") -->
  <script src="../assets/js/auth-guard.js"></script>

  <div class="max-w-7xl mx-auto px-4 py-12">
    <h1 class="text-3xl md:text-4xl font-extrabold">HREI Lead CRM</h1>
    <p class="mt-2 text-slate-700">This table shows all leads from the database. This page is for internal use only.</p>
    
    <div class="mt-8 bg-white p-6 rounded-xl shadow-md overflow-x-auto">
      <table class="min-w-full text-sm text-left">
        <thead class="bg-slate-100">
          <tr>
            <th class="p-3 font-bold">Address</th>
            <th class="p-3 font-bold">City</th>
            <th class="p-3 font-bold">Stage</th>
            <th class="p-3 font-bold">Asking Price</th>
            <th class="p-3 font-bold">ARV</th>
            <th class="p-3 font-bold">Notes</th>
          </tr>
        </thead>
        <tbody id="crm-tbody" class="divide-y">
          <tr><td colspan="6" class="p-3 text-center text-slate-500">Loading leads...</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <script>
    console.log('=== HREI CRM Page Initializing ===');
    
    // ============================================
    // SUPABASE CONFIGURATION (CORRECT CREDENTIALS)
    // ============================================
    const SUPABASE_URL = 'https://lmivqwscebdupfxxwfcc.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxtaXZxd3NjZWJkdXBmeHh3ZmNjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg1NjQ1NzAsImV4cCI6MjA4NDE0MDU3MH0.AzE-j9Rrz1HRoGNaqicMJ8jEwO1tVuCqbf9E9J3vuv4';
    
    // Check if Supabase library loaded
    if (typeof window.supabase === 'undefined') {
      console.error('‚ùå ERROR: Supabase library not loaded!');
      document.getElementById('crm-tbody').innerHTML = '<tr><td colspan="6" class="p-3 text-center text-red-600">Error: Supabase library failed to load. Check your internet connection.</td></tr>';
    } else {
      console.log('‚úÖ Supabase library loaded successfully');
    }
    
    // Initialize Supabase client
    const _supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    console.log('‚úÖ Supabase client initialized');
    
    // ============================================
    // LOAD ALL LEADS FUNCTION
    // ============================================
    async function loadAllLeads() {
      console.log('üìä Fetching leads from database...');
      const tableBody = document.getElementById('crm-tbody');
      
      if (!tableBody) {
        console.error('‚ùå Table body element not found');
        return;
      }
      
      tableBody.innerHTML = '<tr><td colspan="6" class="p-4 text-center text-slate-500">Loading all leads...</td></tr>';

      try {
        // Fetch ALL leads from Supabase
        const { data, error } = await _supabase
          .from('leads')
          .select('*')
          .order('id', { ascending: false });

        console.log('Supabase Response:', { 
          dataCount: data ? data.length : 0, 
          error: error 
        });

        if (error) {
          console.error('‚ùå Supabase Error:', error);
          tableBody.innerHTML = `<tr><td colspan="6" class="p-4 text-center text-red-500">Error: ${error.message}<br/>Check console for details.</td></tr>`;
          return;
        }

        if (!data || data.length === 0) {
          console.log('‚ÑπÔ∏è No leads found in database');
          tableBody.innerHTML = '<tr><td colspan="6" class="p-4 text-center text-slate-500">No leads found in the database.</td></tr>';
          return;
        }

        console.log(`‚úÖ Successfully loaded ${data.length} leads`);
        tableBody.innerHTML = '';
        
        // Render each lead as a table row
        for (const lead of data) {
          const row = document.createElement('tr');
          row.className = 'hover:bg-slate-50';
          row.innerHTML = `
            <td class="p-3">${lead.property_address || ''}</td>
            <td class="p-3">${lead.city || ''}</td>
            <td class="p-3"><span class="px-2 py-1 text-xs font-semibold rounded-full bg-blue-100 text-blue-800">${lead.stage || 'New Lead'}</span></td>
            <td class="p-3">$${lead.asking_price ? lead.asking_price.toLocaleString() : 'N/A'}</td>
            <td class="p-3">$${lead.arv ? lead.arv.toLocaleString() : 'N/A'}</td>
            <td class="p-3 text-slate-600">${lead.notes ? (lead.notes.length > 100 ? lead.notes.substring(0, 100) + '...' : lead.notes) : ''}</td>
          `;
          tableBody.appendChild(row);
        }
        
        console.log('‚úÖ Table rendered successfully');
        
      } catch (err) {
        console.error('‚ùå Unexpected error:', err);
        tableBody.innerHTML = `<tr><td colspan="6" class="p-4 text-center text-red-500">Unexpected error: ${err.message}</td></tr>`;
      }
    }

    // ============================================
    // INITIALIZE PAGE
    // ============================================
    document.addEventListener('DOMContentLoaded', () => {
      console.log('üìÑ DOM loaded, initializing CRM...');
      loadAllLeads();
    });
    
    console.log('=== CRM Script Loaded ===');
  </script>
</body>
</html>
